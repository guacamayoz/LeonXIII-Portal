<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>PORTAL LEON XIII</title>
    <link rel="icon" href="assets\logo.png">
    <!-- Fuentes -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" />
    <!-- Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
    <!-- MDB -->
    <link rel="stylesheet" href="css/mdb.min.css" />
    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <style>
      #intro {
        background-image: url("assets/background.png");
        height: 100vh;
      }

      /* Altura de Copyright para dispositivos con mas de 576px */
      @media (min-width: 992px) {
        #intro {
          margin-top: -58.59px;
        }
      }

      .navbar .nav-link {
        color: #fff !important;
      }
    </style>

    <!-- Imagen de fondo -->
    <div id="intro" class="bg-image shadow-2-strong">
      <div class="mask d-flex align-items-center h-100" style="background-color: rgba(0, 0, 0, 0.8);">
        <div class="container">
          <!--logo del colegio en pantalla chica-->
          <div class="row justify-content-center">
            <div class="text-center d-lg-none col-5 col-sm-4 col-md-4 m-5">
                <img src="assets\Logo.png" class="img-fluid">
            </div>
          </div>
          <!--logo del colegio en pantalla grande-->
          <div class="row justify-content-center">
            <div class="text-center d-none d-lg-block col-lg-4 col-xl-5 pt-5 pb-2">
                <img src="assets\Logo.png" class="img-fluid">
            </div>
            <div class="col-xl-5 col-md-8 mb-5">
              <!--Contenedor del formulario-->
              <form class="bg-white rounded shadow-5-strong p-5" id="login-form">
                <div>
                  <header class="text-center mb-3 colorTexto">
                  <h1 class="font-weight-bold">LEON XIII</h1><h2>CASA SALESIANA <br> OBRA DE DON BOSCO</h2></header>
                </div>
                <div class="text-center">
                  <h6>RED PARA ALUMNOS</h6>
                </div>
                <!-- Ingreso de contraseña -->
                <div class="form-outline m-3" id="input-simple">
                  <input type="password" id="simplePassword" name="simplePassword" class="form-control" />
                    <label class="form-label" for="form1Example2">
                      Contraseña
                    </label>
                </div>
                <div class="col text-center mb-4">
                  <!-- PopOver si olvidaste la contraseña -->
                  <a href="#!" data-bs-toggle="popover" data-bs-placement="top" data-bs-trigger="focus" data-bs-content="Consulta la contraseña con el profesor mas cercano">Olvidaste la contraseña?</a>
                </div>
                <!-- Boton de Submit -->
                <div id="button-area">
                  <button type="submit" id="button-login" class="btn btn-primary btn-block">
                    Ingresar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!--Footer-->
  <footer class="bg-light text-lg-start">

    <hr class="m-0" />

    <!-- Copyright -->
    <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
      © 2022 Copyright:
      <a class="text-dark" href="http://vaix.com.ar/">VAIX</a>
    </div>
    <!-- Copyright -->
  </footer>
  <!--Footer-->
    <!-- Scripts -->
    <script type="text/javascript" src="js/mdb.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.bundle.js"></script>
    <script type="text/javascript">
    $(function () {
        $("[rel='tooltip']").tooltip();
    });
    </script>
    <script type="text/javascript">
      var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
  return new bootstrap.Popover(popoverTriggerEl)
})
    </script>
    <script type="text/javascript">
    var Ajax = {
        post: function (url, data, fn) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 304)) {
                    fn.call(this, xhr.responseText);
                }
            };
            xhr.send(data);
        }
    };
    var data = {};
    var globalConfig = {};
    var submitUrl;
    var clientMac = getQueryStringKey("clientMac");
    var apMac = getQueryStringKey("apMac");
    var gatewayMac = getQueryStringKey("gatewayMac") || undefined;
    var ssidName = getQueryStringKey("ssidName") || undefined;
    var radioId = !!getQueryStringKey("radioId")? Number(getQueryStringKey("radioId")) : undefined;
    var vid = !!getQueryStringKey("vid")? Number(getQueryStringKey("vid")) : undefined;
    var originUrl = getQueryStringKey("originUrl");
    var previewSite = getQueryStringKey("previewSite");

    var hotspotMap = {
        3: "Voucher Access",
        5: "Local User Access",
        6: "SMS Access",
        8: "RADIUS Access"
    };

    var errorHintMap = {
        "0": "ok",
        "-1": "Error general.",
        "-41500": "Invalid authentication type.",
        "-41501": "Fallo para autenticar.",
        "-41502": "Incorrect voucher code.",
        "-41503": "This voucher code is expired.",
        "-41504": "The traffic used by this voucher code has reached the limit.",
        "-41505": "The number of users has reached the limit.",
        "-41506": "Invalid authorization information.",
        "-41507": "Your authentication times out. You can get authenticated again until the next day.",
        "-41508": "The traffic used by this local user has reached the limit.",
        "-41512": "This local user is expired.",
        "-41513": "This local user is disabled.",
        "-41514": "Incorrect MAC address.",
        "-41516": "The number of users has reached the limit.",
        "-41517": "Contraseña incorrecta.",
        "-41518": "This SSID does not exist.",
        "-41519": "Invalid code.",
        "-41520": "The code is expired.",
        "-41521": "The number of users has reached the limit.",
        "-41522": "Failed to validate the code.",
        "-41523": "Failed to send verification code.",
        "-41524": "Authentication failed because the username does not exsit.",
        "-41525": "Fallo de autenticacion debido a contraseña incorrecta.",
        "-41526": "Authentication failed because the client is invalid.",
        "-41527": "Authentication failed because the local user is invalid."
    };

    var facebookUrl = !!apMac? ('/portal/fbwifi/forward?clientMac='+encodeURIComponent(clientMac)+'&apMac='+encodeURIComponent(apMac)+'&ssidName='+encodeURIComponent(ssidName)+'&radioId='+encodeURIComponent(radioId)+'&originUrl='+encodeURIComponent(originUrl))
        : ('/portal/fbwifi/forward?clientMac='+encodeURIComponent(clientMac)+'&gatewayMac='+encodeURIComponent(gatewayMac)+'&vid='+encodeURIComponent(vid)+'&originUrl='+encodeURIComponent(originUrl));

    var isCommited;
    function getQueryStringKey (key) {
        return getQueryStringAsObject()[key];
    }
    function getQueryStringAsObject () {
        var b, cv, e, k, ma, sk, v, r = {},
            d = function (v) { return decodeURIComponent(v); }, //# d(ecode) the v(alue)
            q = window.location.search.substring(1), //# suggested: q = decodeURIComponent(window.location.search.substring(1)),
            s = /([^&;=]+)=?([^&;]*)/g //# original regex that does not allow for ; as a delimiter:   /([^&=]+)=?([^&]*)/g
        ;
        ma = function(v) {
            if (typeof v != "object") {
                cv = v;
                v = {};
                v.length = 0;
                if (cv) { Array.prototype.push.call(v, cv); }
            }
            return v;
        };
        while (e = s.exec(q)) {
            b = e[1].indexOf("[");
            v = d(e[2]);
            if (b < 0) {
                k = d(e[1]);
                if (r[k]) {
                    r[k] = ma(r[k]);
                    Array.prototype.push.call(r[k], v);
                }
                else {
                    r[k] = v;
                }
            }
            else {
                k = d(e[1].slice(0, b));
                sk = d(e[1].slice(b + 1, e[1].indexOf("]", b)));
                r[k] = ma(r[k]);
                if (sk) { r[k][sk] = v; }
                else { Array.prototype.push.call(r[k], v); }
            }
        }
        return r;
    }
    Ajax.post(
        '/portal/getPortalPageSetting',
        JSON.stringify({
            "clientMac": clientMac,
            "apMac": apMac,
            "gatewayMac": gatewayMac,
            "ssidName": ssidName,
            "radioId": radioId,
            "vid": vid,
            "originUrl": originUrl
        }),
        function (res) {
            res = JSON.parse(res);
            data = res.result;
            submitUrl           = "/portal/auth";
            var landingUrl  = data.landingUrl;
            isCommited          = false;
            globalConfig = {
                authType: data.authType,
                hotspotTypes: !!data.hotspot && data.hotspot.enabledTypes || [],
                error         : data.error || 'ok',
                countryCode   : !!data.sms && data.sms.countryCode || 1
            };
            function pageConfigParse(){
                if (res.errorCode !== 0){
                    document.getElementById("oper-hint").style.display = "block";
                    document.getElementById("oper-hint").innerHTML = errorHintMap[res.errorCode];
                }
                document.getElementById("hotspot-section").style.display = "none";
                document.getElementById("input-voucher").style.display = "none";
                document.getElementById("input-user").style.display = "none";
                document.getElementById("input-password").style.display = "none";
                document.getElementById("input-simple").style.display = "none";
                document.getElementById("input-phone-num").style.display = "none";
                document.getElementById("input-verify-code").style.display = "none";
                document.getElementById("button-facebook").style.display = "none";
                switch (globalConfig.authType){
                    case 0:
                        window.authType = 0;
                        break;
                    case 1:
                        document.getElementById("input-simple").style.display = "block";
                        window.authType = 1;
                        break;
                    case 2:
                        hotspotChang(2);
                        window.authType = 2;
                        break;
                    case 7:
                        document.getElementById("button-facebook").style.display = "block";
                        document.getElementById("button-facebook").addEventListener("click", function () {
                            window.location.href = facebookUrl;
                        });
                        document.getElementById("button-login").style.display = "none";
                        window.authType = 7;
                        break;
                    case 11:
                        document.getElementById("hotspot-section").style.display = "block";
                        var options = "";
                        for (var i=0;i<globalConfig.hotspotTypes.length;i++) {
                            options += '<option value="'+globalConfig.hotspotTypes[i]+'">'+hotspotMap[globalConfig.hotspotTypes[i]]+'</option>';
                        }
                        document.getElementById("hotspot-selector").innerHTML = options;
                        hotspotChang(globalConfig.hotspotTypes[0]);
                        window.authType = globalConfig.hotspotTypes[0];
                        break;
                }
            }

            function handleSubmit(){
                var submitData = {};
                submitData['authType'] = window.authType;
                switch (window.authType){
                    case 3:
                        submitData['voucherCode'] = document.getElementById("voucherCode").value;
                        break;
                    case 5:
                        submitData['localuser'] = document.getElementById("username").value;
                        submitData['localuserPsw'] = document.getElementById("password").value;
                        break;
                    case 1:
                        submitData['simplePassword'] = document.getElementById("simplePassword").value;
                        break;
                    case 0:
                        break;
                    case 6:
                        submitData['phone'] = "+"+document.getElementById("country-code").value + document.getElementById("phone-number").value;
                        submitData['code'] = document.getElementById("verify-code").value;
                        break;
                    case 2:
                    case 8:
                        submitData['username'] = document.getElementById("username").value;
                        submitData['password'] = document.getElementById("password").value;
                        break;
                    default:
                        break;
                }

                if(isCommited == false){
                    submitData['clientMac'] = clientMac;
                    submitData['apMac'] = apMac;
                    submitData['gatewayMac'] = gatewayMac;
                    submitData['ssidName'] = ssidName;
                    submitData['radioId'] = radioId;
                    submitData['vid'] = vid;
                    if(window.authType == 2 || window.authType == 8){
                        submitUrl = "/portal/radius/auth";
                        submitData['authType'] = window.authType;
                    } else {
                        submitData['originUrl'] = originUrl;
                    }
                    function doAuth () {
                        Ajax.post(submitUrl, JSON.stringify(submitData).toString(), function(data){
                            data = JSON.parse(data);
                            if(!!data && data.errorCode === 0) {
                                isCommited = true;
                                window.location.href = landingUrl;
                                document.getElementById("oper-hint").innerHTML = errorHintMap[data.errorCode];
                            } else{
                                document.getElementById("oper-hint").innerHTML = errorHintMap[data.errorCode];
                            }
                        });
                    }
                    doAuth();
                }
            }
            function hotspotChang (type) {

                document.getElementById("input-voucher").style.display = "none";
                document.getElementById("input-user").style.display = "none";
                document.getElementById("input-password").style.display = "none";
                document.getElementById("input-phone-num").style.display = "none";
                document.getElementById("input-verify-code").style.display = "none";
                document.getElementById("button-login").style.display = "block";
                window.authType = Number(type);
                switch (Number(type)) {
                    case 3:
                        document.getElementById("input-voucher").style.display = "block";
                        break;
                    case 5:
                    case 2:
                    case 8:
                        document.getElementById("input-user").style.display = "block";
                        document.getElementById("input-password").style.display = "block";
                        break;
                    case 6:
                        document.getElementById("input-phone-num").style.display = "block";
                        document.getElementById("input-verify-code").style.display = "block";
                        break;
                }
            }
            globalConfig.countryCode = "+" + parseInt(globalConfig.countryCode, 10);
            document.getElementById("country-code").value = parseInt(globalConfig.countryCode, 10);
            document.getElementById("hotspot-selector").addEventListener("change", function () {
                var obj = document.getElementById("hotspot-selector");
                var opt = obj.options[obj.selectedIndex];
                hotspotChang(opt.value);
            });
            document.getElementById("button-login").addEventListener("click", handleSubmit);
            document.getElementById("get-code").addEventListener("click", function(e){
                e.preventDefault();
                var phoneNum = document.getElementById("phone-number").value;
                function sendSmsAuthCode () {
                    Ajax.post("/portal/sendSmsAuthCode",
                        JSON.stringify({
                            clientMac: clientMac,
                            apMac: apMac,
                            gatewayMac: gatewayMac,
                            ssidName: ssidName,
                            radioId: radioId,
                            vid: vid,
                            phone: "+" + document.getElementById("country-code").value + phoneNum
                        }),function(data){
                            data = JSON.parse(data);
                            if(data.errorCode !== 0){
                                document.getElementById("oper-hint").innerHTML = errorHintMap[data.errorCode];
                            } else {
                                document.getElementById("oper-hint").innerHTML = "SMS has been sent successfully.";
                            }
                        }
                    );
                }
                sendSmsAuthCode();
                document.getElementById("oper-hint").innerHTML = "Sending Authorization Code...";
            });
            pageConfigParse();
        }
    );
</script>
</body>
</html>